trigger:
  branches:
    include:
      - main
      - dev
  paths:
    exclude:
      - README.md
      - '**/*.md'

pr:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - '**/*.md'

pool:
  name: Default   # Self-hosted Mac agent

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'

jobs:
- job: Build
  displayName: "Java CI with Maven"
  timeoutInMinutes: 30

  steps:
    - checkout: self
      clean: true

    - script: |
        echo "----- JAVA VERSION BEFORE BUILD -----"
        java -version
        mvn -version
      displayName: "Verify Environment"

    # -------------------------------------------------------------------
    # 1Ô∏è‚É£ BUILD / COMPILE  ‚Äî does not block pipeline
    # -------------------------------------------------------------------
    - script: mvn -f java/pom.xml -B clean compile
      displayName: "Build with Maven"
      continueOnError: true

    # -------------------------------------------------------------------
    # 2Ô∏è‚É£ CHECKSTYLE  ‚Äî does not block pipeline
    # -------------------------------------------------------------------
    - script: mvn -f java/pom.xml -B checkstyle:check
      displayName: "Run Checkstyle"
      continueOnError: true

    # -------------------------------------------------------------------
    # 3Ô∏è‚É£ Switch JDK to Java 21 for test + JaCoCo coverage
    # -------------------------------------------------------------------
    - task: JavaToolInstaller@0
      displayName: "Switch to Java 21 for Testing & Coverage"
      inputs:
        versionSpec: '21'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'

    - script: |
        echo "----- Java version used for Tests and Coverage -----"
        java -version
        mvn -version
      displayName: "Confirm Java Version for Testing"

    # -------------------------------------------------------------------
    # 4Ô∏è‚É£ UNIT TESTS + COVERAGE (ALL MODULES) ‚Äî does not block pipeline
    # -------------------------------------------------------------------
    - script: mvn -f java/pom.xml -B test jacoco:report
      displayName: "Run Tests with Coverage (All Modules)"
      continueOnError: true

    # -------------------------------------------------------------------
    # 5Ô∏è‚É£ PACKAGE JARs  ‚Äî ALWAYS runs even if earlier steps failed
    # -------------------------------------------------------------------
    - script: mvn -f java/pom.xml -B package -DskipTests
      displayName: "Package Application"
      continueOnError: true

    # -------------------------------------------------------------------
    # 6Ô∏è‚É£ PUBLISH TEST RESULTS
    # -------------------------------------------------------------------
    - task: PublishTestResults@2
      displayName: "Publish Unit Test Results"
      condition: always()
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/surefire-reports/TEST-*.xml'
        mergeTestResults: true
        failTaskOnFailedTests: false

    # -------------------------------------------------------------------
    # 7Ô∏è‚É£ PUBLISH COVERAGE REPORTS
    # -------------------------------------------------------------------
    - task: PublishCodeCoverageResults@1
      displayName: "Publish JaCoCo Coverage"
      condition: always()
      inputs:
        codeCoverageTool: 'JaCoCo'
        summaryFileLocation: '**/jacoco.xml'
        reportDirectory: '**/site/jacoco'
        failIfCoverageEmpty: false

    # -------------------------------------------------------------------
    # 8Ô∏è‚É£ COPY BUILD ARTIFACTS
    # -------------------------------------------------------------------
    - task: CopyFiles@2
      displayName: "Copy Build Artifacts"
      condition: always()
      inputs:
        sourceFolder: '$(System.DefaultWorkingDirectory)'
        contents: |
          **/target/*.jar
          **/site/**
        targetFolder: '$(Build.ArtifactStagingDirectory)'

    # -------------------------------------------------------------------
    # 9Ô∏è‚É£ PUBLISH ARTIFACTS
    # -------------------------------------------------------------------
    - task: PublishBuildArtifacts@1
      displayName: "Publish Build Artifacts"
      condition: always()
      inputs:
        pathToPublish: '$(Build.ArtifactStagingDirectory)'
        artifactName: 'java-build-artifacts'
        publishLocation: 'Container'

    # -------------------------------------------------------------------
    # üîü SUMMARY
    # -------------------------------------------------------------------
    - script: |
        echo "##[section] üöÄ Build Summary"
        echo "üß± Build executed (errors allowed)"
        echo "üß™ Tests executed across ALL modules"
        echo "üìä Coverage executed using Java 21"
        echo "üì¶ JAR(s) published as artifact"
      displayName: "Display Build Summary"
      condition: always()
